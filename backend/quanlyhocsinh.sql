DROP DATABASE quanlyhocsinh;

CREATE DATABASE quanlyhocsinh CHARACTER SET utf8mb4 COLLATE utf8mb4_vietnamese_ci;
USE quanlyhocsinh;

-- Tạo bảng THAMSO
CREATE TABLE THAMSO (
    TuoiHocSinhToiThieu INT,
    TuoiHocSinhToiDa INT,
    SoLuongHocSinhToiDa INT,
    DiemToiDa FLOAT,
    DiemToiThieu FLOAT,
    DiemDat FLOAT
);

-- Tạo bảng NAMHOC
CREATE TABLE NAMHOC (
    MaNamHoc VARCHAR(255) PRIMARY KEY,
    Nam1 INT NOT NULL,
    Nam2 INT NOT NULL
);

-- Tạo bảng HOCKY
CREATE TABLE HOCKY (
    MaHocKy INT AUTO_INCREMENT PRIMARY KEY,
    TenHocKy NVARCHAR(50)
);
INSERT INTO HOCKY (MaHocKy, TenHocKy) VALUES ('1', 'Học kỳ I'), ('2', 'Học kỳ II');

-- Tạo bảng LOAIKIEMTRA
CREATE TABLE LOAIKIEMTRA (
    MaLKT INT PRIMARY KEY,
    TenLKT NVARCHAR(50),
    HeSo FLOAT
);
INSERT INTO LOAIKIEMTRA (MaLKT, TenLKT, HeSo) VALUES ('1', '15 phút', '1'), ('2', '1 tiết', '2'), ('3', 'học kỳ', '3');

-- Tạo bảng KHOILOP
CREATE TABLE KHOILOP (
    MaKhoi INT AUTO_INCREMENT PRIMARY KEY,
    TenKhoi NVARCHAR(50) NOT NULL
);

-- Tạo bảng LOP
CREATE TABLE LOP (
    MaLop INT AUTO_INCREMENT PRIMARY KEY,
    TenLop NVARCHAR(50) NOT NULL,
    MaKhoi INT NOT NULL,
    FOREIGN KEY (MaKhoi) REFERENCES KHOILOP(MaKhoi) ON DELETE CASCADE
);

-- Tạo bảng DANHSACHLOP
CREATE TABLE DANHSACHLOP (
    MaDanhSachLop INT AUTO_INCREMENT PRIMARY KEY,
    MaNamHoc VARCHAR(255) NOT NULL,
    MaLop INT NOT NULL,
    SiSo INT NOT NULL,
    FOREIGN KEY (MaNamHoc) REFERENCES NAMHOC(MaNamHoc) ON DELETE CASCADE,
    FOREIGN KEY (MaLop) REFERENCES LOP(MaLop) ON DELETE CASCADE
);

-- Tạo bảng HOCSINH
CREATE TABLE HOCSINH (
    MaHocSinh INT AUTO_INCREMENT PRIMARY KEY,
    TenHocSinh NVARCHAR(50) NOT NULL,
    NgaySinh DATE NOT NULL,
    DiaChi NVARCHAR(100),
    Email NVARCHAR(100),
    GioiTinh NVARCHAR(10) NOT NULL
);

-- Tạo bảng CT_DSL
CREATE TABLE CT_DSL (
    MaCT_DSL INT AUTO_INCREMENT PRIMARY KEY,
    MaDanhSachLop INT NOT NULL,
    MaHocSinh INT NOT NULL,
    FOREIGN KEY (MaDanhSachLop) REFERENCES DANHSACHLOP(MaDanhSachLop) ON DELETE CASCADE,
    FOREIGN KEY (MaHocSinh) REFERENCES HOCSINH(MaHocSinh) ON DELETE CASCADE
);

-- Tạo bảng MONHOC
CREATE TABLE MONHOC (
    MaMonHoc INT AUTO_INCREMENT PRIMARY KEY,
    TenMonHoc NVARCHAR(50) NOT NULL,
    DiemDatMonHoc FLOAT NOT NULL
);

-- Tạo bảng BANGDIEM
CREATE TABLE BANGDIEM (
    MaBangDiem INT AUTO_INCREMENT PRIMARY KEY,
    MaCT_DSL INT NOT NULL,
    MaHocKy INT NOT NULL,
    DTBHK FLOAT NOT NULL,
    FOREIGN KEY (MaCT_DSL) REFERENCES CT_DSL(MaCT_DSL) ON DELETE CASCADE,
    FOREIGN KEY (MaHocKy) REFERENCES HOCKY(MaHocKy) ON DELETE CASCADE
);

-- Tạo bảng BD_MONHOC
CREATE TABLE BD_MONHOC (
    MaBD_MH INT AUTO_INCREMENT PRIMARY KEY,
    MaBangDiem INT NOT NULL,
    MaMonHoc INT NOT NULL,
    DTBMH FLOAT NOT NULL,
    FOREIGN KEY (MaBangDiem) REFERENCES BANGDIEM(MaBangDiem) ON DELETE CASCADE,
    FOREIGN KEY (MaMonHoc) REFERENCES MONHOC(MaMonHoc) ON DELETE CASCADE
);

-- Tạo bảng BD_THANHPHAN
CREATE TABLE BD_THANHPHAN (
    MaBD_TP INT AUTO_INCREMENT PRIMARY KEY,
    MaBD_MH INT,
    MaLKT INT,
    KetQua FLOAT,
    FOREIGN KEY (MaBD_MH) REFERENCES BD_MONHOC(MaBD_MH),
    FOREIGN KEY (MaLKT) REFERENCES LOAIKIEMTRA(MaLKT),

    UNIQUE KEY (MaBD_MH, MaLKT)
);

-- Tạo bảng BC_TKMH
CREATE TABLE BC_TKMH (
    MaBC_TKM INT AUTO_INCREMENT PRIMARY KEY,
    MaNamHoc VARCHAR(255),
    MaMonHoc INT,
    MaHocKy INT,
    FOREIGN KEY (MaNamHoc) REFERENCES NAMHOC(MaNamHoc),
    FOREIGN KEY (MaMonHoc) REFERENCES MONHOC(MaMonHoc),
    FOREIGN KEY (MaHocKy) REFERENCES HOCKY(MaHocKy)
);

-- Tạo bảng BC_TKHK
CREATE TABLE BC_TKHK (
    MaBC_TKHK INT AUTO_INCREMENT PRIMARY KEY,
    MaHocKy INT,
    MaDanhSachLop INT,
    SoLuongDat INT,
    TiLe FLOAT,
    FOREIGN KEY (MaHocKy) REFERENCES HOCKY(MaHocKy),
    FOREIGN KEY (MaDanhSachLop) REFERENCES DANHSACHLOP(MaDanhSachLop)
);

ALTER TABLE BANGDIEM MODIFY COLUMN DTBHK FLOAT DEFAULT 0;
ALTER TABLE BD_MONHOC MODIFY COLUMN DTBMH FLOAT DEFAULT 0;